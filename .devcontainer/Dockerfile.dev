# Development Dockerfile for Yapay SDK - Alpine environment
FROM golang:1.21-alpine

# Install build dependencies including CGO support and development tools
RUN apk add --no-cache \
    git \
    ca-certificates \
    tzdata \
    gcc \
    musl-dev \
    make \
    curl \
    wget \
    jq \
    vim \
    nano \
    htop \
    tree \
    bash \
    bash-completion \
    netcat-openbsd \
    tcpdump \
    strace \
    gdb \
    && rm -rf /var/cache/apk/*

# Install CloudPub tunnel tool (optional)
RUN CLOUDPUB_VERSION="2.4.1" && \
    CLOUDPUB_ARCH="linux-x86_64" && \
    CLOUDPUB_URL="https://cloudpub.ru/download/stable/clo-${CLOUDPUB_VERSION}-stable-${CLOUDPUB_ARCH}.tar.gz" && \
    wget -q "$CLOUDPUB_URL" -O "clo-${CLOUDPUB_VERSION}-stable-${CLOUDPUB_ARCH}.tar.gz" && \
    tar -xf "clo-${CLOUDPUB_VERSION}-stable-${CLOUDPUB_ARCH}.tar.gz" && \
    chmod +x ./clo && \
    mv ./clo /usr/local/bin/clo && \
    rm -f "clo-${CLOUDPUB_VERSION}-stable-${CLOUDPUB_ARCH}.tar.gz" || \
    echo "CloudPub tunnel installation failed - continuing without it"

# Install Go development tools (optional - can be installed later)
RUN go install github.com/go-delve/delve/cmd/dlv@latest || echo "delve installation failed" && \
    go install github.com/air-verse/air@latest || echo "air installation failed"

# Create development user (same as production)
RUN addgroup -g 1001 -S yapay && \
    adduser -u 1001 -S yapay -G yapay

# Set working directory
WORKDIR /workspace

# Copy go mod files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Create directories for SDK development
RUN mkdir -p /workspace/sdk /workspace/examples /workspace/tools /workspace/plugins

# Set up bash completion and aliases
RUN echo 'source /usr/share/bash-completion/bash_completion' >> /home/yapay/.bashrc && \
    echo 'alias ll="ls -la"' >> /home/yapay/.bashrc && \
    echo 'alias la="ls -la"' >> /home/yapay/.bashrc && \
    echo 'alias ..="cd .."' >> /home/yapay/.bashrc && \
    echo 'alias ...="cd ../.."' >> /home/yapay/.bashrc && \
    echo 'export PATH=$PATH:/go/bin' >> /home/yapay/.bashrc && \
    echo 'export GOPATH=/go' >> /home/yapay/.bashrc

# Set ownership
RUN chown -R yapay:yapay /workspace

# Switch to development user
USER yapay

# Expose ports
EXPOSE 8080 8081 2345 8082

# Set environment variables
ENV GO111MODULE=on
ENV GOPROXY=https://proxy.golang.org,direct
ENV GOSUMDB=sum.golang.org
ENV CGO_ENABLED=1
ENV GOOS=linux
ENV GOARCH=amd64
ENV LOG_LEVEL=debug
ENV GIN_MODE=debug
ENV AIR_WORKSPACE=/workspace/sdk
ENV AIR_TMP_DIR=/tmp

# Default command
CMD ["bash"]
