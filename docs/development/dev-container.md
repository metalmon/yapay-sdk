# Контейнер разработчика Yapay SDK

Этот документ описывает настройку и использование контейнера разработчика для Yapay SDK.

## Обзор

Контейнер разработчика предоставляет:
- **Изолированную среду** на базе Yapay сервера (metalmon/yapay:latest)
- **Полный набор инструментов** разработки (Go, отладка, профилирование)
- **Возможности hot reloading**
- **Интеграционное тестирование** с Yapay сервером
- **CloudPub туннель** для тестирования webhook'ов

### Что такое metalmon/yapay:latest?

Это Docker образ основного Yapay сервера, который содержит:
- **Скомпилированный Yapay сервер** (yapay-server)
- **Базовую Alpine Linux** среду
- **Необходимые runtime зависимости** (curl, ca-certificates, tzdata)
- **Пользователя yapay** для безопасности
- **Health check** для мониторинга

Образ создается из основного проекта yapay и используется как база для контейнера разработчика SDK.

## Быстрый старт

### Вариант 1: DevContainer (рекомендуется)

**Требования:**
- Docker Desktop
- VS Code с расширением Dev Containers

**Установка:**
1. Откройте проект в VS Code
2. Нажмите `Ctrl+Shift+P` → "Dev Containers: Reopen in Container"
3. Дождитесь сборки контейнера
4. Начните разработку!

### Вариант 2: Ручная настройка

**Требования:**
- Docker и Docker Compose установлены
- Make утилита доступна
- Минимум 4GB RAM для контейнеров

**Настройка:**
```bash
# Клонируем репозиторий (если еще не сделано)
git clone <repository-url>
cd yapay-sdk

# Запускаем автоматическую настройку
./scripts/dev-setup.sh

# Или используем Make команды
make dev-setup
```

**Начало разработки:**
```bash
# Запуск контейнера разработчика
make dev-run

# Открытие shell в контейнере
make dev-shell

# Запуск тестов
make dev-test
```

## Команды контейнера разработчика

### Основные операции

| Команда | Описание |
|---------|----------|
| `make dev-build` | Сборка контейнера разработчика |
| `make dev-run` | Запуск контейнера разработчика |
| `make dev-stop` | Остановка контейнера разработчика |
| `make dev-shell` | Открытие shell в контейнере |
| `make dev-restart` | Перезапуск контейнера разработчика |

### Инструменты разработки

| Команда | Описание |
|---------|----------|
| `make dev-test` | Запуск тестов в контейнере |
| `make dev-lint` | Запуск линтера в контейнере |
| `make dev-fmt` | Форматирование кода в контейнере |
| `make dev-security` | Запуск сканирования безопасности |
| `make dev-check` | Запуск всех проверок (fmt, lint, test, security) |

### Отладка

| Команда | Описание |
|---------|----------|
| `make dev-debug` | Запуск сессии отладки (порт 2345) |
| `make dev-logs` | Показ логов контейнера |
| `make dev-status` | Показ статуса контейнера |
| `make dev-health` | Проверка здоровья контейнера |

### Разработка плагинов

| Команда | Описание |
|---------|----------|
| `make dev-plugins` | Сборка и тестирование плагинов |
| `make dev-server` | Запуск Yapay сервера для интеграции |
| `make dev-reload` | Hot reload с новым кодом |
| `make dev-tunnel` | Запуск CloudPub туннеля для тестирования webhook'ов |
| `make dev-tunnel-start` | Запуск CloudPub туннеля |
| `make dev-tunnel-stop` | Остановка CloudPub туннеля |
| `make dev-tunnel-status` | Показ статуса туннеля |
| `make dev-tunnel-url` | Получение URL туннеля |

### Утилиты

| Команда | Описание |
|---------|----------|
| `make dev-clean` | Очистка контейнера и volumes |
| `make dev-stats` | Показ использования ресурсов |
| `make dev-export-logs` | Экспорт логов в файл |

## Интерактивные скрипты

### Скрипт настройки разработки

```bash
./scripts/dev-setup.sh
```

Автоматизированная настройка, которая:
- Собирает контейнер разработчика
- Запускает все сервисы
- Устанавливает зависимости
- Запускает начальные тесты
- Показывает доступные команды

### Скрипт отладки

```bash
./scripts/dev-debug.sh
```

Интерактивное меню для отладки:
- Запуск сервера отладки (Delve)
- Открытие shell в контейнере
- Показ логов и статуса здоровья
- Запуск тестов с отладочным выводом
- Профилирование использования памяти и CPU
- Инструменты сетевой отладки

### Скрипт тестирования

```bash
./scripts/dev-test.sh
```

Комплексное тестирование:
- Unit тесты
- Интеграционные тесты
- Тесты плагинов
- Benchmark тесты
- Линтинг и сканирование безопасности
- Анализ покрытия кода

## URLs разработки

- **SDK Development Server**: http://localhost:8080
- **Debug Port**: 2345 (для подключения IDE)
- **Yapay Server**: http://localhost:8082 (интеграционное тестирование)
- **CloudPub Tunnel**: https://xxx.cloudpub.ru (для тестирования webhook'ов)

## Интеграция с IDE

### VS Code

1. Установите расширение "Go"
2. Установите расширение "Delve" для отладки
3. Подключитесь к debug порту 2345

### GoLand/IntelliJ

1. Настройте удаленную отладку
2. Установите host: localhost, port: 2345
3. Используйте опцию "Attach to Process"

### Vim/Neovim

1. Установите плагин vim-go
2. Используйте команду `:GoDebug`
3. Подключитесь к localhost:2345

## Архитектура контейнера

### Сервисы

1. **yapay-sdk-dev**: Основной контейнер разработки
   - Основан на образе Yapay сервера (metalmon/yapay:latest)
   - Включает инструменты разработки Go
   - Монтирует исходный код SDK
   - Предоставляет возможности отладки

2. **yapay-server-dev**: Сервер интеграционного тестирования
   - Отдельный экземпляр Yapay сервера
   - Используется для интеграционного тестирования
   - Работает на порту 8082

### Volumes

- **Исходный код**: Монтируется как read-write для разработки
- **Go Module Cache**: Персистентный для быстрых сборок
- **Build Cache**: Персистентный для быстрой компиляции
- **Development Tools Cache**: Персистентный для инструментов

### Сети

- **yapay-dev-network**: Изолированная bridge сеть
- **Внутренняя коммуникация** между сервисами
- **Без внешнего Traefik** (только для разработки)

## CloudPub туннель для тестирования webhook'ов

### Обзор

CloudPub туннель предоставляет внешний доступ к вашему локальному серверу разработки для тестирования webhook'ов и внешних интеграций. Это необходимо для тестирования callback'ов платежей и уведомлений webhook'ов.

### Быстрый старт

```bash
# Запуск среды разработки
make dev-run

# Запуск CloudPub туннеля
make dev-tunnel

# Получение URL туннеля
TUNNEL_URL=$(make dev-tunnel-url)
echo "Ваш URL туннеля: $TUNNEL_URL"
```

### Команды туннеля

| Команда | Описание |
|---------|----------|
| `make dev-tunnel` | Запуск CloudPub туннеля (алиас для dev-tunnel-start) |
| `make dev-tunnel-start` | Запуск CloudPub туннеля |
| `make dev-tunnel-stop` | Остановка CloudPub туннеля |
| `make dev-tunnel-status` | Показ статуса туннеля и URL |
| `make dev-tunnel-url` | Получение только URL туннеля |
| `make dev-tunnel-restart` | Перезапуск CloudPub туннеля |

### Использование туннеля

1. **Запуск туннеля**:
   ```bash
   make dev-tunnel-start
   ```

2. **Получение URL туннеля**:
   ```bash
   TUNNEL_URL=$(make dev-tunnel-url)
   echo "URL туннеля: $TUNNEL_URL"
   ```

3. **Тестирование webhook endpoint**:
   ```bash
   curl -X POST "$TUNNEL_URL/api/v1/webhook" \
     -H "Content-Type: application/json" \
     -d '{"test": "data"}'
   ```

4. **Настройка внешних сервисов**:
   - Используйте URL туннеля как webhook URL во внешних сервисах
   - Тестируйте callback'и платежей от Yandex Pay
   - Тестируйте уведомления и интеграции

### Переменные окружения

- `CLOUDPUB_TOKEN` - токен аутентификации CloudPub (опционально, для расширенных функций)

### Устранение неполадок

- **Туннель не запускается**: Убедитесь, что сервер разработки запущен (`make dev-run`)
- **Туннель недоступен**: Подождите несколько секунд для установления туннеля
- **Проблемы с аутентификацией**: Установите переменную окружения `CLOUDPUB_TOKEN`

## Рабочий процесс разработки

### 1. Ежедневная разработка

```bash
# Запуск среды разработки
make dev-run

# Открытие shell для разработки
make dev-shell

# В контейнере: разработка вашего кода
cd /workspace/sdk
vim main.go  # или ваш предпочитаемый редактор

# Тестирование изменений
make test

# Запуск конкретных тестов
go test -v ./examples/simple-plugin
```

### 2. Разработка плагинов

```bash
# Создание нового плагина
make new-plugin NAME=my-plugin

# Сборка и тестирование плагина
make dev-plugins

# Тестирование с Yapay сервером
make dev-server
make dev-plugins
```

### 3. Отладка

```bash
# Запуск сессии отладки
make dev-debug

# В IDE: подключение к localhost:2345

# Или использование интерактивного помощника отладки
./scripts/dev-debug.sh
```

### 4. Тестирование

```bash
# Запуск комплексного набора тестов
./scripts/dev-test.sh

# Или отдельные типы тестов
make dev-test      # Unit тесты
make dev-lint      # Линтинг
make dev-security  # Сканирование безопасности
```

## Устранение неполадок

### Контейнер не запускается

```bash
# Проверка статуса Docker
docker info

# Проверка конфликтов портов
netstat -tlnp | grep :8080

# Очистка и пересборка
make dev-clean
make dev-build
```

### Проблемы с подключением отладки

```bash
# Проверка debug порта
netstat -tlnp | grep :2345

# Перезапуск сессии отладки
make dev-debug
```

### Проблемы с производительностью

```bash
# Проверка использования ресурсов
make dev-stats

# Очистка кэшей
make dev-clean
```

### Проблемы с загрузкой плагинов

```bash
# Проверка директории плагинов
make dev-shell
ls -la /workspace/plugins/

# Пересборка плагинов
make dev-plugins
```

## Переменные окружения

### Контейнер разработки

- `GO111MODULE=on`: Включение Go модулей
- `CGO_ENABLED=1`: Включение CGO для плагинов
- `LOG_LEVEL=debug`: Отладочное логирование
- `GIN_MODE=debug`: Режим отладки для веб-сервера

### Yapay Server

- `PORT=8082`: Порт сервера
- `LOG_LEVEL=debug`: Отладочное логирование
- `GIN_MODE=debug`: Режим отладки

## Лучшие практики

### 1. Разработка

- Используйте `make dev-shell` для интерактивной разработки
- Запускайте тесты часто с `make dev-test`
- Используйте режим отладки для сложных проблем
- Держите контейнер запущенным для быстрой итерации

### 2. Тестирование

- Запускайте полный набор тестов перед коммитами
- Используйте интеграционные тесты для валидации плагинов
- Профилируйте производительность для оптимизации
- Регулярно проверяйте сканирование безопасности

### 3. Отладка

- Используйте скрипт помощника отладки для сложных проблем
- Профилируйте использование памяти и CPU
- Мониторьте сетевой трафик при необходимости
- Экспортируйте логи для анализа

### 4. Производительность

- Используйте персистентные volumes для быстрых сборок
- Периодически очищайте кэши
- Мониторьте использование ресурсов
- Оптимизируйте Docker образы

## Безопасность

### Среда разработки

- **Никаких production секретов** в разработке
- **Изолированная сеть** для разработки
- **Нет внешнего доступа** к сервисам разработки
- **Чистые контейнеры** после разработки

### Безопасность кода

- **Сканирование безопасности** запускается автоматически
- **Никаких захардкоженных секретов** в коде
- **Валидация** всех входных данных
- **Санитизация** данных перед логированием

## Вклад в разработку

### Перед коммитом

```bash
# Запуск всех проверок
make dev-check

# Запуск комплексных тестов
./scripts/dev-test.sh

# Очистка
make dev-clean
```

### Code Review

- Убедитесь, что все тесты проходят
- Проверьте результаты сканирования безопасности
- Проверьте benchmark'и производительности
- Просмотрите отладочный вывод

## Поддержка

### Получение помощи

1. Проверьте эту документацию
2. Запустите `make help` для доступных команд
3. Используйте скрипт помощника отладки для устранения неполадок
4. Проверьте логи контейнера на ошибки

### Сообщение о проблемах

1. Экспортируйте логи: `make dev-export-logs`
2. Включите детали окружения
3. Предоставьте шаги воспроизведения
4. Приложите соответствующие файлы логов

---

**Счастливой разработки с Yapay SDK! 🚀**
